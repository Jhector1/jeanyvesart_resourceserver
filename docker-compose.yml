
services:
  jeanyvesart-server-app:
    build:
      context: .
      dockerfile: Dockerfile
    image: jeanyvesart-server-app:latest
    container_name: jeanyvesart-server-app
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Force internal server port
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: prod

      # Postgres connection for Spring (matches application.properties)
      PROD_DB_HOST: postgres
      PROD_DB_PORT: 5432
      PROD_DB_NAME: ${PROD_DB_NAME}
      PROD_DB_USERNAME: ${PROD_DB_USERNAME}
      PROD_DB_PASSWORD: ${PROD_DB_PASSWORD}

      # Mail
      SPRING_MAIL_PORT: ${SPRING_MAIL_PORT}
      GMAIL_USERNAME: ${GMAIL_USERNAME}
      GMAIL_PASSWORD: ${GMAIL_PASSWORD}

      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_KEY: ${STRIPE_WEBHOOK_KEY}

      # Base URLs
      CLIENT_BASE_URL: ${CLIENT_BASE_URL}
      SERVER_BASE_URL: ${SERVER_BASE_URL}
    depends_on:
      - postgres
    networks:
      - public

  postgres:
    image: postgres:16
    container_name: myapp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${PROD_DB_NAME}
      POSTGRES_USER: ${PROD_DB_USERNAME}
      POSTGRES_PASSWORD: ${PROD_DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - public

networks:
  public:
    external: true  # use the shared network created with `docker network create web`

volumes:
  postgres_data:
